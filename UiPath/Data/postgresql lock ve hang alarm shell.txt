
#!/bin/bash
. /home/postgres/.bash_profile

psql -U postgres -d postgres << EOF > /tmp/lock_sess.out
select pid, 
       usename, 
       pg_blocking_pids(pid) as blocked_by, 
       query as blocked_query
from pg_stat_activity
where cardinality(pg_blocking_pids(pid)) > 0;
EOF

pgcontrol=`cat /tmp/lock_sess.out | grep  "0 rows" | wc -l `

smtpmail=thyappmail.thy.com
tomail=ithfgencali@thy.com
frommail=thyserver@thy.com 


if [[ $pgcontrol -ne 1 ]]; then
echo "Meramedas:  `hostname` postgresql prod da lock var"  | mailx -s "Postgresql Lock" -r "$frommail" -S smtp="$smtpmail" $tomail
fi

cn=`/usr/pgsql-12/bin/pg_isready | grep  "accepting connections" | wc -l`

if [[ $cn -ne 1 ]]; then
echo "Meramedas:  `hostname` postgresql prod da connection lari kabul etmiyor"  | mailx -s "Postgresql Hang" -r "$frommail" -S smtp="$smtpmail" $tomail
fi

